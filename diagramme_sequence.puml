@startuml
title RogueLike Game Sequence

actor Player
participant MainApplication
participant MainMenu
participant GameManager
participant GameScene
participant Entity
participant Dragon
participant SaveManager
participant PlayerCreation
participant SaveData
participant Potion

Player -> MainApplication: lance le jeu
activate MainApplication

MainApplication -> MainMenu: crée
activate MainMenu

alt Nouvelle Partie
    Player -> MainMenu: clique "Nouvelle Partie"
    MainMenu -> SaveManager: deleteSave()
    MainMenu -> GameManager: crée
    activate GameManager
    
    GameManager -> PlayerCreation: createPlayer(playerClass)
    activate PlayerCreation
    PlayerCreation --> GameManager: nouveau Player
    deactivate PlayerCreation
    
    GameManager -> GameScene: crée(player)
else Continuer Partie
    Player -> MainMenu: clique "Continuer"
    MainMenu -> SaveManager: loadGame()
    activate SaveManager
    SaveManager --> MainMenu: SaveData
    deactivate SaveManager
    
    MainMenu -> PlayerCreation: createPlayer(saveData.playerClass)
    PlayerCreation --> MainMenu: Player
    MainMenu -> GameScene: crée(player, saveData)
end

activate GameScene
GameScene -> GameScene: setupUI()
GameScene -> GameScene: setupBackground()
GameScene -> GameScene: setupPlatforms()
GameScene -> GameScene: setupHealthBar()
GameScene -> GameScene: setupWaveUI()
GameScene -> GameScene: setupInventory()
GameScene -> GameScene: setupSpecialAbility()
GameScene -> GameScene: setupControls()
GameScene -> GameScene: startGameLoop()
GameScene -> GameScene: createGameOverScreen()
GameScene -> GameScene: createPauseMenu()
GameScene -> GameScene: startNextWave()

loop Game Loop tant que !isGameOver et !isPaused
    GameScene -> GameScene: update()
    GameScene -> GameScene: handleMovement()
    GameScene -> Entity: moveLeft()/moveRight()
    GameScene -> GameScene: applyGravity()
    GameScene -> GameScene: checkCollision()
    GameScene -> GameScene: updateDemons()
    GameScene -> GameScene: updateHealthBar()
    GameScene -> GameScene: updateTimer()
    GameScene -> GameScene: checkPotionCollision()
    GameScene -> GameScene: checkGameOver()
    GameScene -> GameScene: updateCooldownBar()
    GameScene -> GameScene: checkSpecialAbilityEffects()
end

Player -> GameScene: appuie sur touches
alt Attaque (A)
    GameScene -> GameScene: handleAttack()
    GameScene -> Entity: canAttack()
    GameScene -> Entity: attack()
    GameScene -> Entity: resetAttackCooldown()
    GameScene -> Dragon: takeDamage()
end

alt Saut (UP)
    GameScene -> GameScene: jump()
end

alt Capacité Spéciale (Z)
    GameScene -> Entity: useSpecialAbility()
    GameScene -> Entity: canUseSpecialAbility()
    alt Warrior
        Entity -> Entity: heal(shieldAmount)
    else Wizard
        Entity -> Dragon: takeDamage(dragon.getCurrentHealth() / 2)
    else Assassin
        Entity -> Entity: isSpecialActive = true
    else Doctor
        Entity -> Entity: heal(missingHealth / 3)
    end
end

alt Utilisation Potion (E/R)
    GameScene -> GameScene: usePotion(slot)
    GameScene -> Entity: heal(30)
end

alt Game Over
    GameScene -> GameScene: checkGameOver()
    activate GameScene
    GameScene -> GameScene: stopWaveSpawning()
    GameScene -> GameScene: clearDemons()
    GameScene -> GameScene: showGameOverScreen()
    deactivate GameScene
end

alt Pause (ESCAPE)
    Player -> GameScene: appuie sur ESCAPE
    GameScene -> GameScene: togglePauseMenu()
    GameScene -> SaveManager: saveGame()
    activate SaveManager
    SaveManager -> SaveData: crée
    SaveManager -> SaveManager: écrit game_save.json
    deactivate SaveManager
end

alt Spawn de Démons
    GameScene -> GameScene: startNextWave()
    activate GameScene
    GameScene -> GameScene: calculateDemonsForWave()
    loop tant que remainingDemonsToSpawn > 0 et !isGameOver
        GameScene -> GameScene: spawnDemon()
        GameScene -> Dragon: crée
        activate Dragon
        Dragon --> GameScene: nouveau Dragon
        deactivate Dragon
    end
    deactivate GameScene
end

alt Spawn de Potions
    GameScene -> GameScene: spawnPotion()
    GameScene -> Potion: crée
    activate Potion
    Potion --> GameScene: nouvelle Potion
    deactivate Potion
end

alt Fermeture du jeu
    Player -> MainApplication: ferme la fenêtre
    MainApplication -> GameScene: saveGame()
    GameScene -> SaveManager: saveGame(saveData)
    activate SaveManager
    SaveManager -> SaveManager: écrit game_save.json
    deactivate SaveManager
end

@enduml